#!/bin/bash
# memory - Helix Memory CLI wrapper
# Usage: memory <command> [args]
#
# Commands:
#   start               Start HelixDB (auto-starts Docker Desktop if needed)
#   stop                Stop HelixDB
#   restart             Restart HelixDB
#   status              Check HelixDB status
#   search <query>      Search memories by content
#   list [--limit N]    List all memories
#   store <content>     Store a new memory
#   delete <id>         Delete memory by ID (supports prefix)
#   tag <tag>           Find memories by tag
#   recall <topic>      Alias for search (natural language)
#   remember <content>  Quick store with auto-categorization
#   show <id>           Show memory details by ID

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || echo "$0")")" && pwd)"
HELPER="$SCRIPT_DIR/scripts/memory_helper.py"
CONFIG_FILE="$HOME/.helix-memory.conf"

# Read config file if it exists
if [ -f "$CONFIG_FILE" ]; then
    HELIX_BIN=$(grep -E "^helix_bin\s*=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ' | sed "s|~|$HOME|g")
    HELIX_URL=$(grep -E "^url\s*=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
fi

# Defaults if not in config
HELIX_BIN="${HELIX_BIN:-$HOME/.local/bin/helix}"
HELIX_URL="${HELIX_URL:-http://localhost:6969}"

# Function to check if Docker is running
docker_running() {
    docker info &>/dev/null
}

# Function to start Docker Desktop if not running
ensure_docker() {
    if docker_running; then
        return 0
    fi

    echo "Docker not running. Starting Docker Desktop..."
    open -a "Docker Desktop"

    # Wait for Docker to start (max 60 seconds)
    local attempts=0
    while ! docker_running; do
        if [ $attempts -ge 30 ]; then
            echo "ERROR: Docker Desktop failed to start within 60 seconds"
            return 1
        fi
        sleep 2
        attempts=$((attempts + 1))
        printf "."
    done
    echo " Docker ready!"
    return 0
}

# Function to check if HelixDB is running
helix_running() {
    curl -s --connect-timeout 2 "$HELIX_URL/GetAllMemories" -X POST -H "Content-Type: application/json" -d '{}' &>/dev/null
}

case "$1" in
    start)
        if helix_running; then
            echo "HelixDB already running"
            python3 "$HELPER" status
            exit 0
        fi

        ensure_docker || exit 1

        echo "Starting HelixDB..."
        cd "$SCRIPT_DIR" && "$HELIX_BIN" push dev

        # Wait for helix to be ready
        sleep 2
        if helix_running; then
            echo "HelixDB started successfully"
            python3 "$HELPER" status
        else
            echo "HelixDB may still be starting... check 'memory status' in a moment"
        fi
        ;;
    stop)
        if ! helix_running; then
            echo "HelixDB is not running"
            exit 0
        fi

        echo "Stopping HelixDB..."
        cd "$SCRIPT_DIR" && "$HELIX_BIN" stop dev
        echo "HelixDB stopped"
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    status|st)
        python3 "$HELPER" status
        ;;
    search|s)
        shift
        python3 "$HELPER" search "$@"
        ;;
    list|ls)
        shift
        python3 "$HELPER" list "$@"
        ;;
    store|add)
        shift
        if [ -z "$1" ]; then
            echo "Usage: memory store <content> [-t category] [-i importance] [-g tags]"
            exit 1
        fi
        # Check if explicit flags provided
        has_flags=false
        for arg in "$@"; do
            case "$arg" in
                -t|-i|-g|--category|--importance|--tags) has_flags=true; break ;;
            esac
        done
        if $has_flags; then
            # Explicit flags: pass through to store
            if [[ "$1" == "-c" || "$1" == "--content" ]]; then
                python3 "$HELPER" store "$@"
            else
                python3 "$HELPER" store -c "$@"
            fi
        else
            # No flags: auto-categorize (same as remember)
            content="$*"
            echo "Analyzing memory..."
            json=$(python3 "$HELPER" categorize "$content" 2>/dev/null)
            if [ -n "$json" ] && command -v jq >/dev/null; then
                category=$(echo "$json" | jq -r '.category // "fact"')
                importance=$(echo "$json" | jq -r '.importance // 5')
                tags=$(echo "$json" | jq -r '.tags // ""')
            elif [ -n "$json" ]; then
                category=$(echo "$json" | python3 -c "import sys,json; print(json.load(sys.stdin).get('category','fact'))" 2>/dev/null || echo "fact")
                importance=$(echo "$json" | python3 -c "import sys,json; print(json.load(sys.stdin).get('importance',5))" 2>/dev/null || echo "5")
                tags=$(echo "$json" | python3 -c "import sys,json; print(json.load(sys.stdin).get('tags',''))" 2>/dev/null || echo "")
            else
                category="fact"; importance=5; tags=""
            fi
            python3 "$HELPER" store -c "$content" -t "$category" -i "$importance" -g "$tags" --force
        fi
        ;;
    delete|del|rm)
        shift
        if [ -z "$1" ]; then
            echo "Usage: memory delete <memory-id>"
            exit 1
        fi
        python3 "$HELPER" delete "$1"
        ;;
    tag|by-tag)
        shift
        python3 "$HELPER" by-tag "$1"
        ;;
    recall|r)
        shift
        python3 "$HELPER" search "$*"
        ;;
    show)
        shift
        if [ -z "$1" ]; then
            echo "Usage: memory show <memory-id>"
            exit 1
        fi
        python3 "$HELPER" show "$1"
        ;;
    remember|rem)
        # Alias for store (same behavior)
        shift
        exec "$0" store "$@"
        ;;
    health)
        shift
        python3 "$HELPER" health "$@"
        ;;
    garbage)
        shift
        python3 "$HELPER" garbage "$@"
        ;;
    link)
        shift
        python3 "$HELPER" link "$@"
        ;;
    merge)
        shift
        python3 "$HELPER" merge "$@"
        ;;
    curate)
        shift
        # Support: curate, curate analyze, curate review, curate apply
        python3 "$HELPER" curate "$@"
        ;;
    dedup)
        shift
        python3 "$HELPER" dedup "$@"
        ;;
    help|--help|-h)
        cat << 'EOF'
Helix Memory CLI

Usage: memory <command> [args]

Service Commands:
  start                   Start HelixDB (auto-starts Docker Desktop if needed)
  stop                    Stop HelixDB
  restart                 Restart HelixDB
  status, st              Check HelixDB status and memory count

Memory Commands:
  search, s <query>       Search memories by content
  list, ls [--limit N]    List all memories (sorted by importance)
  store/add/remember/rem  Store memory (auto-categorizes; optional: -t -i -g)
  delete, rm <id>         Delete memory by ID (prefix matching OK)
  tag <tag>               Find memories by tag
  recall, r <topic>       Search memories (alias)
  show <id>               Show memory details by ID

Curation Commands:
  health [-v] [-t]        Memory health report (-t for thorough vector analysis)
  garbage [-n] [-f]       Find/delete garbage memories (-n dry-run, -f force)
  dedup [-n] [-f]         Find/delete duplicates
  link <from> <to> [-r]   Create edge between memories
  merge <keep> <del...>   Merge duplicates (keep one, delete rest)
  curate [analyze]        Analyze memories, save pending actions (background-safe)
  curate review           Show pending curation actions
  curate apply            Execute pending actions (--links-only, --deletes-only, --merges-only)

Examples:
  memory start            # Start HelixDB (starts Docker if needed)
  memory health -v        # Detailed health report
  memory garbage --dry-run # Preview garbage without deleting
  memory merge abc123 def456 ghi789  # Keep abc, delete def+ghi
  memory link 1f0c60d1 1f0dc0ac -r related  # Link two memories

Categories: preference, fact, context, decision, task, solution
EOF
        ;;
    "")
        python3 "$HELPER" status
        ;;
    *)
        # Default: treat as search query (backward compatible)
        python3 "$HELPER" search "$*"
        ;;
esac
